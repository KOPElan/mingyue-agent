# PRD: Mingyue Agent

## 1. Product overview

### 1.1 Document title and version

- PRD: Mingyue Agent
- Version: 1.0

### 1.2 Product summary

Mingyue Agent 是明月Portal家庭服务器生态的核心本地管理服务，兼具远程协作 agent 与本地宿主机特权操作 helper 职能。项目采用单进程架构，支持多机部署、与 WebUI 分离，专注于家庭/个人服务器自动化管理。首发版本以 Linux 环境为主，提供高性能、可扩展的 API 服务和 CLI 工具，后续将与 WebUI 深度集成。

## 2. Goals

### 2.1 Business goals

- 提升家庭/个人服务器自动化管理体验
- 降低运维复杂度，增强安全性与可控性
- 支持多机协作与分布式管理
- 为后续WebUI开发提供标准化接口与数据基础

### 2.2 User goals

- 便捷管理本地和远程服务器资源
- 安全执行特权操作，防止误操作和权限滥用
- 高效文件、磁盘、网络、资源监控与管理
- 可通过CLI快速操作和集成自动化脚本

### 2.3 Non-goals

- 不包含WebUI前端实现
- 不支持非Linux平台
- 不涉及特殊安全合规（如GDPR、国密等）
- 不提供第三方云服务集成

## 3. User personas

### 3.1 Key user types

- 家庭用户
- 开发者
- 高级运维人员

### 3.2 Basic persona details

- **家庭用户**：希望简化服务器日常管理，保障数据安全，轻松配置共享与备份。
- **开发者**：关注接口标准、自动化能力、可扩展性，期望集成自定义任务和脚本。
- **高级运维人员**：需要批量管理多台设备，关注安全、审计、性能和故障恢复。

### 3.3 Role-based access

- **管理员**：拥有全部操作权限，包括特权操作、配置变更、审计管理。
- **普通用户**：仅限于受控目录浏览、文件操作、资源查看。

## 4. Functional requirements

- **通信与接口** (Priority: High)
  - 支持 gRPC/REST (HTTPS) API，mTLS/Token 认证，UDS 本地通道。
  - 启动后主动注册 WebUI（预留接口），支持被 WebUI 扫描/发现。
  - 全部接口结构化参数，严格类型与路径/范围白名单校验。
  - RBAC 管控、请求限流。

- **文件管理** (Priority: High)
  - 文件目录浏览、属性查看（根路径/白名单目录，多级分页、排序）。
  - 文件操作：新建、删除、重命名、移动、复制、上传、下载、软/硬链接。
  - 受控下载/断点续传、并发限制、速率控制。
  - 文件预览（图片、文档、媒体缩略图）。
  - 只读/可写权限配置，操作全审计记录。
  - 极致输入校验，防路径遍历、特殊符号注入。

- **本地磁盘管理** (Priority: Medium)
  - 分区管理：自动检测/刷新/展示分区信息，受控挂载/卸载。
  - 磁盘SMART信息读取（只读API）。
  - 电源策略管理（可选，全部变化留审计）。
  - 挂载点整理/监控，异常报警。
  - 危险操作多重确认。

- **网络磁盘管理** (Priority: Medium)
  - CIFS/NFS共享发现与挂载卸载，白名单配置、凭证加密管理。
  - 远程目录权限配置，安全模板化操作，全部变更审计。
  - 挂载监控与断线自动检测/恢复。

- **系统网络管理** (Priority: Medium)
  - 网络接口/端口/流量实时监控。
  - 手动IP设置和网口管理（仅管理口），静态IP/DHCP切换、禁/启用、历史回退。
  - 连接变动、异常日志和配置更改审计。

- **系统资源监控** (Priority: High)
  - CPU、内存、存储、文件句柄数等API拉取。
  - 节点健康状态/进程状态监控，/healthz端点与systemd Watchdog。

- **共享管理（Samba/NFS）** (Priority: Medium)
  - 共享目录创建/修改/删除，严格白名单、用户权限配置。
  - 配置生成/热更新，变更操作审计、原子化回滚。
  - 共享目录健康检测，异常自动告警。

- **索引、缩略图与资源管理** (Priority: Medium)
  - 本地资源扫描/增量索引，元数据表生成、API分页查询。
  - 图片/文档/视频缩略图自动生成，缓存管理、冷热数据分层。
  - FullText/标签/属性扩展接口，安全健康清理策略。

- **定时任务与任务编排** (Priority: Medium)
  - 中心编排、分布式本地执行，任务定义与调度参数保存。
  - Agent任务同步与本地调度，断线容忍、任务持久化。
  - 任务执行与反馈，进度、结果、异常日志实时上报。
  - 任务参数强校验、权限边界白名单，任务类型可扩展。

- **日志、审计与安全加固** (Priority: High)
  - 所有特权/敏感操作强制留档，日志本地存储、远端推送、集中备份。
  - 认证与授权体系：mTLS节点认证、API token、登录会话。
  - 最小特权原则，主进程非root运行，特权操作临时提权。
  - 输入校验及安全检查，禁用任意命令拼接，自动化SAST/SCA检查。
  - 部署支持seccomp/AppArmor/systemd加固、镜像签名/验证。

## 5. User experience

### 5.1 Entry points & first-time user flow

- CLI工具安装与初始化
- Agent进程启动后自动注册（预留WebUI接口）
- 配置文件生成与编辑
- API接口测试与集成

### 5.2 Core experience

- **资源浏览与操作**：用户通过CLI或API浏览文件、磁盘、网络资源，执行受控操作。
  - 权限校验与审计保障安全。
- **任务编排与监控**：用户可配置定时任务，实时查看执行进度与结果。
  - 断线容忍与本地持久化提升可靠性。
- **系统健康监控**：用户可随时获取节点状态，自动告警异常。
  - 提升运维效率与故障响应。

### 5.3 Advanced features & edge cases

- 多实例部署与自动发现
- 特权操作多重确认与审批流
- 断点续传、速率控制、并发限制
- 异常自动恢复与回滚
- 审计日志导出与远端推送

### 5.4 UI/UX highlights

- CLI命令结构清晰，支持自动补全与帮助
- API接口文档自动生成
- 配置文件支持注释与模板
- 审计与日志可视化（后续WebUI集成）

## 6. Narrative

用户通过CLI或API快速管理本地和远程服务器资源，所有操作均受权限与审计保障。Agent自动注册与发现，支持多机协作与分布式管理。任务编排、资源监控、特权操作等功能提升日常管理效率，保障系统安全与稳定。

## 7. Success metrics

### 7.1 User-centric metrics

- CLI操作成功率
- API调用成功率
- 文件/磁盘/网络操作延迟
- 审计日志完整性

### 7.2 Business metrics

- 多机协作部署数量
- 用户活跃度与功能使用频率
- 故障恢复时间

### 7.3 Technical metrics

- 冷启动时间 < 1s
- 百万级文件索引性能
- 任务并发与断线容忍能力
- 日志与审计覆盖率

## 8. Technical considerations

### 8.1 Integration points

- 与后续WebUI接口标准同步设计
- 与系统服务（systemd、AppArmor、smartctl等）集成
- Prometheus/Grafana等第三方监控集成

### 8.2 Data storage & privacy

- 配置、索引、日志本地存储
- 支持远端日志推送与备份
- 权限与审计保障数据安全

### 8.3 Scalability & performance

- 支持多实例部署与自动发现
- 高并发任务调度与资源管理
- CLI与API性能优化

### 8.4 Potential challenges

- 特权操作安全隔离与降权
- 多机协作与自动发现机制
- 断线容忍与任务持久化
- 审计与日志合规存储

## 9. Milestones & sequencing

### 9.1 Project estimate

- Size: 中型项目，预计3-4个月

### 9.2 Team size & composition

- Team size: 3-5人
- Roles involved: Go后端开发、系统运维、测试、产品经理

### 9.3 Suggested phases

- **Phase 1**: 架构设计与核心功能开发（1个月）
  - 守护进程、CLI工具、API骨架、权限与审计体系
- **Phase 2**: 文件、磁盘、网络、资源管理模块开发（1.5个月）
  - 文件操作、磁盘管理、网络管理、资源监控
- **Phase 3**: 任务编排、索引、缩略图、日志与安全加固（1个月）
  - 定时任务、索引与缩略图、日志与安全
- **Phase 4**: 测试、性能优化、文档完善与发布（0.5个月）
  - 单元测试、集成测试、性能调优、接口文档

## 10. User stories

### 10.1 启动与注册

- **ID**: GH-001
- **Description**: 用户通过CLI启动Agent，Agent自动注册并预留WebUI接口。
- **Acceptance criteria**:
  - Agent可通过CLI启动
  - 启动后自动注册（预留WebUI接口）
  - 启动日志完整记录

### 10.2 文件管理

- **ID**: GH-002
- **Description**: 用户可浏览、操作受控目录下的文件，所有操作均受权限与审计保障。
- **Acceptance criteria**:
  - 支持文件目录浏览、属性查看
  - 支持新建、删除、重命名、移动、复制、上传、下载、软/硬链接
  - 操作均有权限校验与审计记录
  - 输入校验防止路径遍历与特殊符号注入

### 10.3 磁盘管理

- **ID**: GH-003
- **Description**: 用户可查看分区信息、挂载/卸载磁盘、读取SMART信息，危险操作需多重确认。
- **Acceptance criteria**:
  - 自动检测/刷新分区信息
  - 支持受控挂载/卸载
  - SMART信息只读API
  - 危险操作多重确认

### 10.4 网络磁盘管理

- **ID**: GH-004
- **Description**: 用户可发现、挂载/卸载CIFS/NFS网络盘，配置安全模板与审计。
- **Acceptance criteria**:
  - 支持CIFS/NFS共享发现与挂载卸载
  - 白名单配置、凭证加密管理
  - 远程目录权限安全模板化
  - 挂载监控与断线自动检测/恢复

### 10.5 系统网络管理

- **ID**: GH-005
- **Description**: 用户可实时监控网络接口、端口、流量，手动配置管理口IP。
- **Acceptance criteria**:
  - 网络接口/端口/流量实时监控
  - 管理口静态IP/DHCP切换、禁/启用、历史回退
  - 连接变动、异常日志和配置更改审计

### 10.6 系统资源监控

- **ID**: GH-006
- **Description**: 用户可通过API获取CPU、内存、存储、文件句柄数等资源状态。
- **Acceptance criteria**:
  - 支持API拉取各类资源状态
  - 节点健康状态/进程状态监控
  - /healthz端点与systemd Watchdog集成

### 10.7 共享管理

- **ID**: GH-007
- **Description**: 用户可创建、修改、删除共享目录，配置权限，健康检测与审计。
- **Acceptance criteria**:
  - 共享目录创建/修改/删除
  - 用户权限配置、分组/ACL
  - 配置生成/热更新、原子化回滚
  - 健康检测与异常告警

### 10.8 索引与缩略图管理

- **ID**: GH-008
- **Description**: 用户可配置资源扫描、增量索引、缩略图生成与缓存管理。
- **Acceptance criteria**:
  - 支持周期任务扫描与元数据表生成
  - 图片/文档/视频缩略图自动生成
  - 缓存冷热分层与自动清理
  - FullText/标签/属性扩展接口

### 10.9 定时任务与编排

- **ID**: GH-009
- **Description**: 用户可配置定时任务，Agent同步并本地执行，断线容忍与结果上报。
- **Acceptance criteria**:
  - 支持中心编排与本地任务同步
  - 断线容忍与任务持久化
  - 任务执行进度、结果、异常日志实时上报
  - 任务参数强校验与权限边界白名单

### 10.10 日志、审计与安全加固

- **ID**: GH-010
- **Description**: 所有特权/敏感操作强制留档，认证与授权体系完善，输入校验与安全加固。
- **Acceptance criteria**:
  - 所有特权/敏感操作均有审计记录
  - 支持mTLS节点认证、API token、登录会话
  - 主进程非root运行，特权操作临时提权
  - 输入校验与安全检查，禁用任意命令拼接
  - 部署支持seccomp/AppArmor/systemd加固