# Mingyue Agent 需求说明书（合并 Agent 与 Helper 版）

## 一、项目背景

Mingyue Agent 作为明月Portal家庭服务器生态的核心本地管理服务，同时承担远程协作的 agent 和拥有本地宿主机特权操作的 helper 职能，面向多机部署、WebUI 分离式架构、新一代家庭/个人服务器自动化管理。Agent 目标是：对内安全、对外联动、灵活高效、极致可控。

---

## 二、总体目标与架构说明

- 提供**单一守护进程**，兼具 API 服务、运维自动化、本地特权管理、索引/多媒体处理等能力，减少组件拆分带来的复杂性和运维难度。
- 与 WebUI/控制中心解耦部署，**所有外部操作接口结构化定义、强安全认证和授权**，实现最小权限、最严输入、防侧信道攻击。
- 支持多点协作：多实例部署、自动注册和发现，便于集群与分布式家庭/公司服务器管理。
- 关键特权操作封装于内部：极小化 TCB，便于系统加固、可信审计与安全运维。

---

## 三、功能需求

### 3.1 通信与接口

- 支持 gRPC/REST (HTTPS) API，配合 mTLS/Token 认证，以及本地优化（UDS）通道。
- Agent 启动后主动注册 WebUI，也能被 WebUI 扫描/发现，支持动态加入与断线重连。
- 全部接口均结构化参数，严格类型与路径/范围白名单校验。
- 支持按角色/来源/设备分级授权、RBAC 管控和请求限流。

---

### 3.2 文件管理

- 支持**文件目录浏览、属性查看**（受限于根路径/白名单目录，支持多级分页、排序）。
- **文件操作**：新建、删除、重命名、移动、复制、上传、下载、软/硬链接操作，所有操作严格权限与防篡改校验。
- **受控下载/断点续传**，并发限制、速率控制，下载/导出给前端或 WebUI。
- **文件预览**：图片、文档、媒体文件支持缩略图与多格式预览（可访问缓存，前端拉取）。
- **受控目录只读/可写权限**配置，防止危险操作影响系统关键路径。
- **操作全审计记录**，包括来源、目标、参数摘要、结果、执行人、多级回溯查询。
- **极致输入校验**，防路径遍历、目录穿越、特殊符号注入与权限绕过。

---

### 3.3 本地磁盘管理

- **分区管理**：自动检测/刷新/展示分区信息，支持受控挂载、卸载。
- **磁盘 SMART 信息读取**：集成 smartctl 或系统能力、返回健康状态、温度、寿命等数据（只读API）。
- **电源策略管理（可选）**：接受配置变更（如休眠、定时开关），适配硬件能力，全部变化需留审计。
- **挂载点整理/监控**：展示/校正挂载点，支持异常报警和通知机制。
- **危险操作多重确认**，如卸载系统盘、格式化等需管理员多步确认/审批流。

---

### 3.4 网络磁盘管理

- **CIFS/NFS共享发现与挂载卸载**：配置白名单、凭证/口令加密管理、参数模板校验、异常自动恢复。
- **远程目录权限配置**：只支持安全模板化操作（如只开放只读、用户权限、严禁任意shell），所有变更产生审计。
- **已挂载网络盘监控与断线自动检测/尝试恢复**，避免死锁挂载点与用户卡顿。

---

### 3.5 系统网络管理

- **网络接口/端口/流量实时监控**：展示已用/空闲IP、MAC、物理接口流量（可与 Node Exporter 集成）。
- **手动 IP 设置和网口管理**：仅支持管理口（受控接口），操作包含静态 IP/DHCP 切换、禁/启用、历史配置回退、防止自断连。
- **连接变动、异常日志和配置更改审计**。

---

### 3.6 系统资源监控

- **CPU、内存、存储、文件句柄数**等 API 拉取，供前端仪表盘、第三方 Prometheus/Grafana 集成展示、状态轮询。
- **节点健康状态/进程状态监控**，支持 /healthz 端点与 systemd Watchdog，自动上报异常与告警。

---

### 3.7 共享管理（Samba/NFS）

- **共享目录创建/修改/删除**：严格目录白名单、用户权限配置，支持分组/ACL、外部认证集成。
- **配置生成/热更新**：修改配置立即 reload (如 systemctl reload smbd)，变更操作审计、原子化回滚（配置出错自动恢复）。
- **共享目录健康检测**：自动检测共享可用性，分享链路异常自动告警。

---

### 3.8 索引、缩略图与资源管理

- **本地资源扫描/增量索引**：支持指定目录/盘符周期任务扫描，生成元数据表（支持API分页查询）。
- **图片/文档/视频缩略图自动生成**：格式判断、分辨率自适应，缓存管理、冷热数据分层、过期自动清理。
- **FullText/标签/属性扩展**：抽象接口，预留后��集成 OCR、全文检索、文件标签等功能。
- **安全健康清理/维护策略**：定时任务自动清理无效/过期缩略图、孤岛索引及异常缓存占用。

---

### 3.9 定时任务与任务编排

- **中心编排，分布式本地执行**：所有定时任务（如缩略图生成、索引重建、磁盘自检等）在 WebUI 端统一计划、可视化配置，保存任务定义和调度参数。
- **Agent任务同步与本地调度**：
    - Agent 定期或通过长连接从 WebUI 拉取最新定时任务队列（支持 cron/周期/立即执行等表达式）。
    - 支持断线容忍——Agent 可缓存已同步的定时任务，即使WebUI/网络短暂故障本地任务照常执行，恢复后再补上上报及同步。
    - 本地任务支持并发、安全隔离、超时与重试、任务持久化。
- **任务执行与反馈**：
    - Agent 在执行定时任务时，实时上报任务进度、结果、异常日志，并持久化本地结果以便断点续传与二次上报。
    - WebUI 支持任务状态可视化、进度跟踪、结果/失败自动通知和历史回溯/审计导出。
- **安全性和扩展性**：
    - 任务参数强校验、来源权限与任务类型边界白名单，防止注入和越权。
    - 任务类型可扩展：除内建任务外，支持后续通过 API 增加新任务类型和插件式处理。

---

### 3.10 日志、审计与安全加固

- **所有特权/敏感操作全部强制留档**：记录操作者、来源IP、参数摘要、时间、结果，日志可本地存储、远端推送、集中合规备份。
- **细化认证与授权体系**：支持基于 mTLS 的节点认证、API token、登录会话/长短令牌结合。
- **最小特权原则和能力分层**：主进程以非 root 运行，需特权操作时临时提权（或分隔子进程）并及时降权。
- **输入校验及安全检查**：所有外部 input 正则与白名单过滤，路径/参数正规化，禁用任意命令拼接，自动化 SAST/SCA 检查。
- **部署支持 seccomp/AppArmor/systemd 加固、镜像签名/验证，健康监控上报与异常自动通知**。

---

## 四、非功能性需求

- **性能**：冷启动<1s，百万级文件索引支撑流畅，基础操作低延迟。
- **可靠性/容错性**：主进程崩溃/掉线子模块不断线、自动重连/重试、持久化核心状态。
- **可维护性/可扩展性**：清晰模块化，接口文档完善、注释清楚，后续便于联动或拆分单独 helper。
- **安全合规**：支持定期安全审计、依赖扫描、配置签名和日志合规存储。
- **部署易用性**：支持一键安装包、Docker 容器、systemd 服务、自动发现与注册。

---

## 五、接口与核心交互流程（概要）

1. **WebUI/控制端发起结构化 API/GRPC 请求** → Agent 完整参数校验和鉴权 → 调用本地核心处理/特权功能 → 返回结构化结果和操作审计
2. **定时任务编排/同步/分发**：WebUI 配置/任务中心统一下发，Agent 同步并本地执行，执行进度/结果/异常持续上报，中心可随时查看、强控和回溯
3. **Agent定期本地任务执行**（索引、缩略图、健康检查、日志整理）→ 主动写入本地/远端 cache 和索引表，WebUI 拉取 API 获取状态
4. **全部关键动作与异常 push 到合规日志/外部监控系统，支持运维自动告警和远程诊断**

---

## 六、合并架构下的安全与风险管理

- **合并风险**：agent 被攻破将直接暴露宿主机权限和敏感接口，所有安全边界需靠最小权限/进程隔离/输入校验/审计全流程补足。
- **缓解措施**：
    - 动作权限分组，永久 drop 能力（capabilities），特权操作用 setuid 分隔/操作后降权。
    - 关键动作要求多步确认/审批和回滚方案。
    - 日志推送/备份到外部第三方，防止本地留有单点。
    - 后续如需进一步加强，预留 helper 可分离（子进程/二进制）的扩展点。

---

> 可根据此文档实现 Go/Rust/.NET 栈下的单进程“Agent”（合并helper功能），或按需拆分。需API/代码骨架/接口定义/权限边界矩阵等可随时补充！
